{% extends "base.html.twig" %}

{% block title %}{{ product.name }} - AliExprass{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('build/assets/home.css') }}">
    <link rel="stylesheet" href="{{ asset('build/assets/product.css') }}">
{% endblock %}

{% set route_name = app.request.attributes.get('_route') %}
{% set categories = [] %}
{% for category in product.category %}
    {% set categories = categories|merge([category.name]) %}
{% endfor %}

{% set related_products = [] %}
{% for category in product.category %}
    {% for productRelated in category.products %}
        {% if productRelated.id != product.id %}
            {% set exists = false %}
            {% for existing in related_products %}
                {% if existing.id == productRelated.id %}
                    {% set exists = true %}
                {% endif %}
            {% endfor %}
            {% if not exists %}
                {% set related_categories = [] %}
                {% for relatedCategory in productRelated.category %}
                    {% set related_categories = related_categories|merge([relatedCategory.name]) %}
                {% endfor %}
                {% set related_products = related_products|merge([{
                    id: productRelated.id,
                    name: productRelated.name,
                    slug: productRelated.slug,
                    image: asset('assets/uploads/products/' ~ productRelated.image),
                    price: productRelated.price,
                    categories: related_categories,
                    tags: productRelated.tags,
                    isBestSeller: productRelated.isBestSeller,
                    isNewArrival: productRelated.isNewArrival,
                    isFeatured: productRelated.isFeatured,
                    isSpecialOffer: productRelated.isSpecialOffer
                }]) %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endfor %}
{% set related_products = related_products|slice(0, 8) %}

{% set review_items = [] %}
{% for review in reviews %}
    {% set review_items = review_items|merge([{
        id: review.id,
        note: review.note,
        comment: review.comment,
        createdAt: review.createdAt ? review.createdAt|date('c') : null,
        author: review.user ? (review.user.firstname ~ ' ' ~ review.user.lastname) : 'Client Aliexprass',
        canDelete: canDeleteReview[review.id]|default(false),
        deleteUrl: canDeleteReview[review.id]|default(false) ? path('delete_review', {'reviewId': review.id}) : null
    }]) %}
{% endfor %}

{% set product_data = {
    id: product.id,
    name: product.name,
    slug: product.slug,
    image: asset('assets/uploads/products/' ~ product.image),
    price: product.price,
    compareAtPrice: (product.price * 120) // 100,
    quantity: product.quantity,
    description: product.description,
    moreInformations: product.moreInformations,
    tags: product.tags,
    categories: categories,
    currency: 'EUR',
    isBestSeller: product.isBestSeller,
    isNewArrival: product.isNewArrival,
    isFeatured: product.isFeatured,
    isSpecialOffer: product.isSpecialOffer,
    links: {
        buy: path('cart_buy', {'id': product.id}),
        add: path('cart_add', {
            'id': product.id,
            'slug': product.slug,
            'routeName': route_name
        })
    }
} %}

{% set user_data = {
    logged: app.user ? true : false,
    loginUrl: path('app_login')
} %}

{% set json_options = constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_UNESCAPED_SLASHES') %}
{% set react_props = {
    product: product_data,
    reviews: review_items,
    related: related_products,
    user: user_data
} %}

{% block body %}
    <div class="container">
        <div
            id="react-product-root"
            data-props="{{ react_props|json_encode(json_options)|e('html_attr') }}"
        >
            <div class="react-home-fallback text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Chargement...</span>
                </div>
                <p class="mt-3 mb-0">Chargement des informations produit...</p>
            </div>
        </div>

        <section id="review-form" class="product-review-form">
            <h2 class="product-review-form__title">Partagez votre avis</h2>
            <p class="product-review-form__description">
                Votre retour aide la communaute a faire les meilleurs choix.
            </p>
            {% if app.user %}
                {{ form_start(form, {
                    attr: {
                        class: 'product-review-form__form'
                    }
                }) }}
                    <div class="product-review-form__group">
                        {{ form_label(form.note) }}
                        {{ form_widget(form.note, {
                            attr: {
                                class: 'product-review-form__range',
                                min: 0,
                                max: 100,
                                step: 5
                            }
                        }) }}
                        {{ form_errors(form.note) }}
                    </div>
                    <div class="product-review-form__group">
                        {{ form_label(form.comment) }}
                        {{ form_widget(form.comment, {
                            attr: {
                                class: 'product-review-form__textarea',
                                rows: 4
                            }
                        }) }}
                        {{ form_errors(form.comment) }}
                    </div>
                    {{ form_rest(form) }}
                    <button class="product-review-form__submit btn btn-fill-out">{{ button_label|default('Soumettre') }}</button>
                {{ form_end(form, {'render_rest': false}) }}
            {% else %}
                <a href="{{ path('app_login') }}" class="product-hero__button product-hero__button--ghost">
                    Se connecter pour laisser un avis
                </a>
            {% endif %}
        </section>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="module" src="{{ asset('build/assets/product.js') }}"></script>
{% endblock %}